<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Loader Interoperable Ajustado</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: white;
    font-family: Arial, sans-serif;
  }
  #status {
    position: fixed;
    top: 20px;
    width: 100%;
    text-align: center;
    font-size: 18px;
  }
  /* Contenedor invisible para render inicial */
  #tempContainer {
    display: none;
  }
</style>
</head>
<body>

<div id="status">Cargando GLB…</div>
<div id="tempContainer"></div>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const MODEL_URL = "https://virtualshubs.github.io/personalizador/cubocubico.glb";

/* ----------------------------------------------------------
   LECTOR GLB (mínimo)
---------------------------------------------------------- */
async function loadGLB(url) {
    const res = await fetch(url);
    const buf = await res.arrayBuffer();

    const dv = new DataView(buf, 0, 12);
    if (dv.getUint32(0, true) !== 0x46546C67) {
        throw new Error("GLB inválido");
    }

    let off = 12;
    let json = null;

    while (off < buf.byteLength) {
        const v = new DataView(buf, off, 8);
        const len = v.getUint32(0, true);
        const type = v.getUint32(4, true);
        off += 8;

        const sub = buf.slice(off, off + len);

        if (type === 0x4E4F534A) { // JSON
            json = new TextDecoder().decode(sub);
        }

        off += len;
    }

    return JSON.parse(json);
}

/* ----------------------------------------------------------
   RECUPERAR URL DESDE EXTRAS -> manifestChunks[]
---------------------------------------------------------- */
function rebuildManifest(scene) {
    if (!scene.nodes) return null;

    for (const n of scene.nodes) {
        if (n.extras && n.extras.manifestChunks) {
            const base64 = n.extras.manifestChunks.join("");
            return JSON.parse(atob(base64));
        }
    }
    return null;
}

/* ----------------------------------------------------------
   PARAMS DE LA URL DEL LOADER (dinámicos)
---------------------------------------------------------- */
function getParams() {
    const q = new URLSearchParams(location.search);
    const out = {};
    for (const [k, v] of q.entries()) out[k] = decodeURIComponent(v);
    return out;
}

/* ----------------------------------------------------------
   CREA URL DEL VISOR + METADATOS INYECTADOS → BASE64
---------------------------------------------------------- */
function buildEncodedURL(base, params) {
    const u = new URL(base);
    for (const k in params) {
        u.searchParams.set(k, params[k]);
    }
    return btoa(u.toString());
}

/* ----------------------------------------------------------
   CREA EL IFRAME FINAL
---------------------------------------------------------- */
function launchFromEncoded(b64) {
    const iframe = document.createElement("iframe");
    iframe.src = atob(b64);
    iframe.style.cssText = `
        position:fixed;
        top:0; left:0;
        width:100vw; height:100vh;
        border:none; z-index:9999;
    `;
    document.body.innerHTML = ""; // Limpiamos DOM
    document.body.appendChild(iframe);
}

/* ----------------------------------------------------------
   PROCESO PRINCIPAL CON RENDER INVISIBLE
---------------------------------------------------------- */
(async () => {
    try {
        document.getElementById("status").textContent = "Leyendo GLB…";

        // 1️⃣ Cargar GLB
        const glb = await loadGLB(MODEL_URL);
        const manifest = rebuildManifest(glb);

        if (!manifest || !manifest.runtimeURL) {
            document.getElementById("status").textContent = "No se encontró manifest.";
            return;
        }

        // 2️⃣ Render temporal invisible (en memoria)
        const tempDiv = document.getElementById("tempContainer");
        const tempIframe = document.createElement("iframe");
        tempIframe.src = manifest.runtimeURL;
        tempDiv.appendChild(tempIframe);

        // Esperar a que se cargue el visor en memoria
        await new Promise(resolve => {
            tempIframe.onload = () => resolve();
        });

        // 3️⃣ Extraer URL y params
        const params = getParams();
        const encoded = buildEncodedURL(manifest.runtimeURL, params);

        // 4️⃣ Limpiar DOM y lanzar iframe final
        document.getElementById("status").textContent = "Abriendo visor…";
        launchFromEncoded(encoded);

    } catch (e) {
        console.error(e);
        document.getElementById("status").textContent = "Error cargando.";
    }
})();
</script>

</body>
</html>

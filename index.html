<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Loader Interoperable</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<style>
  body {
    margin: 0;
    background: #fff;
    color: white;
    font-family: Arial, sans-serif;
  }
  #status {
    position: fixed;
    top: 20px;
    width: 100%;
    text-align: center;
    font-size: 18px;
    z-index: 9999;
  }
</style>
</head>
<body>

<div id="status"></div>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const MODEL_URL = "https://virtualshubs.github.io/personalizador/cubocubico.glb";

/* ----------------------------------------------------------
   LECTOR GLB
---------------------------------------------------------- */
async function loadGLB(url) {
    const res = await fetch(url);
    const buf = await res.arrayBuffer();
    const dv = new DataView(buf, 0, 12);
    if (dv.getUint32(0, true) !== 0x46546C67) throw new Error("GLB inválido");

    let off = 12, json = null;
    while (off < buf.byteLength) {
        const v = new DataView(buf, off, 8);
        const len = v.getUint32(0, true);
        const type = v.getUint32(4, true);
        off += 8;

        const sub = buf.slice(off, off + len);
        if (type === 0x4E4F534A) json = new TextDecoder().decode(sub);

        off += len;
    }
    return JSON.parse(json);
}

/* ----------------------------------------------------------
   RECUPERAR MANIFEST
---------------------------------------------------------- */
function rebuildManifest(scene) {
    if (!scene.nodes) return null;
    for (const n of scene.nodes) {
        if (n.extras?.manifestChunks) {
            return JSON.parse(atob(n.extras.manifestChunks.join("")));
        }
    }
    return null;
}

/* ----------------------------------------------------------
   OBTENER PARAMS DE LA URL
---------------------------------------------------------- */
function getParams() {
    const q = new URLSearchParams(location.search);
    const out = {};
    for (const [k, v] of q.entries()) out[k] = decodeURIComponent(v);
    return out;
}

/* ----------------------------------------------------------
   CONSTRUIR URL CODIFICADA
---------------------------------------------------------- */
function buildEncodedURL(base, params) {
    const u = new URL(base);
    for (const k in params) u.searchParams.set(k, params[k]);
    return btoa(u.toString());
}

/* ----------------------------------------------------------
   LANZAR IFRAME SELLADO
---------------------------------------------------------- */
function launchFromEncoded(b64) {
    const iframe = document.createElement("iframe");
    iframe.src = atob(b64);
    iframe.style.cssText = `
        position:fixed;
        top:0; left:0;
        width:100vw; height:100vh;
        border:none; z-index:9999;
    `;
    
    // Borrar todo el DOM visible del loader antes de agregar el iframe
    document.body.innerHTML = "";
    document.body.appendChild(iframe);
}

/* ----------------------------------------------------------
   PROCESO PRINCIPAL
---------------------------------------------------------- */
(async () => {
    try {
        const status = document.getElementById("status");
        status.textContent = "Leyendo GLB…";

        const glb = await loadGLB(MODEL_URL);
        const manifest = rebuildManifest(glb);
        if (!manifest?.runtimeURL) {
            status.textContent = "No se encontró manifest.";
            return;
        }

        const params = getParams();
        const encoded = buildEncodedURL(manifest.runtimeURL, params);

        status.textContent = "Abriendo visor…";

        launchFromEncoded(encoded);
    } catch (e) {
        console.error(e);
        document.getElementById("status").textContent = "Error cargando.";
    }
})();
</script>

</body>
</html>


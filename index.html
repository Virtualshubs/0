<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Loader Interoperable - HTML desde GLB</title>
<style>
  body {
    margin: 0;
    background: #000;
    color: white;
    font-family: Arial, sans-serif;
  }
  #status {
    position: fixed;
    top: 20px;
    width: 100%;
    text-align: center;
    font-size: 18px;
  }
</style>
</head>
<body>

<div id="status">Cargando GLB…</div>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const MODEL_URL = "https://virtualshubs.github.io/personalizador/darkroom.glb"; // apunta al GLB que descargaste del sellado

/* ----------------------------------------------------------
   FUNCIONES AUXILIARES PARA LEER GLB
---------------------------------------------------------- */
async function loadGLB(url) {
    const res = await fetch(url);
    const buf = await res.arrayBuffer();

    const dv = new DataView(buf, 0, 12);
    if (dv.getUint32(0, true) !== 0x46546C67) {
        throw new Error("GLB inválido");
    }

    let off = 12;
    let json = null;

    while (off < buf.byteLength) {
        const v = new DataView(buf, off, 8);
        const len = v.getUint32(0, true);
        const type = v.getUint32(4, true);
        off += 8;

        const sub = buf.slice(off, off + len);

        if (type === 0x4E4F534A) { // JSON
            json = new TextDecoder().decode(sub);
        }

        off += len;
    }

    return JSON.parse(json);
}

/* ----------------------------------------------------------
   RECUPERAR MANIFEST Y HTML DESDE EXTRAS
---------------------------------------------------------- */
function rebuildManifest(scene) {
    if (!scene.nodes) return null;
    for (const n of scene.nodes) {
        if (n.extras && n.extras.manifestChunks) {
            const base64 = n.extras.manifestChunks.join("");
            return JSON.parse(decodeURIComponent(escape(atob(base64))));
        }
    }
    return null;
}

function rebuildHTML(scene) {
    if (!scene.nodes) return null;
    for (const n of scene.nodes) {
        if (n.extras && n.extras.htmlChunks) {
            const base64 = n.extras.htmlChunks.join("");
            const html = decodeURIComponent(escape(atob(base64)));
            return html;
        }
    }
    return null;
}

/* ----------------------------------------------------------
   PROCESO PRINCIPAL
---------------------------------------------------------- */
(async () => {
    try {
        document.getElementById("status").textContent = "Leyendo GLB…";

        const glb = await loadGLB(MODEL_URL);
        const manifest = rebuildManifest(glb);
        const htmlCode = rebuildHTML(glb);

        if (!htmlCode) {
            document.getElementById("status").textContent = "No se encontró HTML en el GLB.";
            return;
        }

        document.getElementById("status").textContent = "Cargando visor…";

        // --- Crear BLOB y mostrarlo sin exponer la URL ---
        const blob = new Blob([htmlCode], {type: "text/html"});
        const blobURL = URL.createObjectURL(blob);

        // Borrar DOM antes de cargar el HTML
        document.body.textContent = "";

        // Saltar al HTML generado
        location.href = blobURL;

    } catch (e) {
        console.error(e);
        document.getElementById("status").textContent = "Error cargando GLB.";
    }
})();
</script>

</body>
</html>

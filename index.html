<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Loader 3dtwins</title>
<style>
  body {
    margin: 0;
    background: transparent;
    color: white;
    font-family: Arial, sans-serif;
  }
  #status {
    position: fixed;
    top: 20px;
    width: 100%;
    text-align: center;
    font-size: 18px;
  }
  /* Contenedor invisible para render inicial */
  #tempContainer {
    display: none;
  }
</style>
</head>
<body>

<div id="status"></div>
<div id="tempContainer"></div>

<script>
/* ----------------------------------------------------------
   CONFIG
---------------------------------------------------------- */
const MODEL_URL = "https://virtualshubs.github.io/personalizador/cubocubico.glb";

/* ----------------------------------------------------------
   LECTOR GLB (mínimo)
---------------------------------------------------------- */
async function loadGLB(url) {
    const res = await fetch(url);
    const buf = await res.arrayBuffer();
    const dv = new DataView(buf, 0, 12);
    if (dv.getUint32(0, true) !== 0x46546C67) throw new Error("GLB inválido");
    let off = 12, json = null;
    while (off < buf.byteLength) {
        const v = new DataView(buf, off, 8);
        const len = v.getUint32(0, true);
        const type = v.getUint32(4, true);
        off += 8;
        const sub = buf.slice(off, off + len);
        if (type === 0x4E4F534A) json = new TextDecoder().decode(sub);
        off += len;
    }
    return JSON.parse(json);
}

/* ----------------------------------------------------------
   RECUPERAR URL DESDE EXTRAS -> manifestChunks[]
---------------------------------------------------------- */
function rebuildManifest(scene) {
    if (!scene.nodes) return null;
    for (const n of scene.nodes) {
        if (n.extras && n.extras.manifestChunks) {
            const base64 = n.extras.manifestChunks.join("");
            return JSON.parse(atob(base64));
        }
    }
    return null;
}

/* ----------------------------------------------------------
   PARAMS DE LA URL DEL LOADER (dinámicos)
---------------------------------------------------------- */
function getParams() {
    const q = new URLSearchParams(location.search);
    const out = {};
    for (const [k, v] of q.entries()) out[k] = decodeURIComponent(v);
    return out;
}

/* ----------------------------------------------------------
   CREA URL DEL VISOR + METADATOS INYECTADOS → BASE64
---------------------------------------------------------- */
function buildEncodedURL(base, params) {
    const u = new URL(base);
    for (const k in params) u.searchParams.set(k, params[k]);
    return btoa(u.toString());
}

/* ----------------------------------------------------------
   DETECCIÓN DE INSPECTOR (inicial y continuo)
---------------------------------------------------------- */
function detectInspector() {
    // Si estamos dentro de un iframe, no hacer nada
    if (window.self !== window.top) return false;

    // Heurística básica para detectar DevTools
    const threshold = 160;
    if (window.outerWidth - window.innerWidth > threshold ||
        window.outerHeight - window.innerHeight > threshold) {
        console.warn("Inspector detectado, eliminando DOM...");
        document.body.innerHTML = "";
        return true;
    }
    return false;
}

// Comprobación inicial
detectInspector();

// Comprobación periódica mientras se visualiza el visor
setInterval(detectInspector, 500);

/* ----------------------------------------------------------
   CREA EL IFRAME FINAL
---------------------------------------------------------- */
function launchFromEncoded(b64) {
    const iframe = document.createElement("iframe");
    iframe.src = atob(b64);
    iframe.style.cssText = `
        position:fixed;
        top:0; left:0;
        width:100vw; height:100vh;
        border:none; z-index:9999;
    `;
    document.body.innerHTML = ""; // Limpiamos DOM principal
    document.body.appendChild(iframe);

    // Dentro del iframe también detecta inspector
    setInterval(() => {
        if (window.outerWidth - window.innerWidth > 160 ||
            window.outerHeight - window.innerHeight > 160) {
            console.warn("Inspector abierto, DOM eliminado.");
            document.body.innerHTML = "";
        }
    }, 500);
}

/* ----------------------------------------------------------
   PROCESO PRINCIPAL CON RENDER INVISIBLE
---------------------------------------------------------- */
(async () => {
    try {
        // Si inspector abierto al inicio, no continuamos
        if (detectInspector()) return;

        const status = document.getElementById("status");
        status.textContent = "Leyendo GLB…";

        // 1️⃣ Cargar GLB
        const glb = await loadGLB(MODEL_URL);
        const manifest = rebuildManifest(glb);

        if (!manifest || !manifest.runtimeURL) {
            status.textContent = "No se encontró manifest.";
            return;
        }

        // 2️⃣ Render temporal invisible (en memoria)
        const tempDiv = document.getElementById("tempContainer");
        const tempIframe = document.createElement("iframe");
        tempIframe.src = manifest.runtimeURL;
        tempDiv.appendChild(tempIframe);

        await new Promise(resolve => tempIframe.onload = () => resolve());

        // 3️⃣ Extraer URL y params
        const params = getParams();
        const encoded = buildEncodedURL(manifest.runtimeURL, params);

        // 4️⃣ Limpiar DOM y lanzar iframe final
        status.textContent = "Abriendo visor…";
        launchFromEncoded(encoded);

    } catch (e) {
        console.error(e);
        document.getElementById("status").textContent = "Error cargando.";
    }
})();
</script>

</body>
</html>
